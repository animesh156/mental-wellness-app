name: CI/CD with Manual Approval

on:
  push:
    branches: [main]

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo
        ports: ['27017:27017']

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install Server Dependencies
      run: |
        cd server
        npm install

    - name: Run Backend Tests (optional)
      run: |
        cd server
        npm test || echo "No backend tests yet"

    - name: Install Client Dependencies
      run: |
        cd client
        npm install

    - name: Build Frontend
      run: |
        cd client
        npm run build

  deploy:
    name: Deploy to Vercel
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Wait for manual approval âœ…
      uses: hmarr/auto-approve-action@v3
      if: github.event_name == 'workflow_dispatch'

    - name: Manual approval step
      uses: chrnorm/deployment-action@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        environment: production
        description: "Click 'Review and Approve' to deploy to production"
        auto-merge: false


    - name: Deploy (placeholder)
      run: echo "ðŸš€ Deploying to Vercel (or Render) manually approved..."
