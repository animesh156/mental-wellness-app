name: CI/CD with Manual Deployment

on:
  workflow_dispatch:

jobs:
  build:
    name: Build & Test (CI)
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo
        ports: ['27017:27017']

    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v3

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Install Server Dependencies
        run: |
          cd server
          npm install

      - name: 🧪 Run Backend Tests
        run: |
          cd server
          npm test || echo "No backend tests yet"

      - name: 📦 Install Client Dependencies
        run: |
          cd client
          npm install

      - name: ⚙️ Build Frontend
        run: |
          cd client
          npm run build

  deploy:
    name: 🚀 Deploy to Vercel (Manual Trigger)
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: 📤 Create GitHub Deployment (requires approval)
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: production
          description: "Click 'Review and Approve' to deploy to production"
          auto-merge: false

      - name: 🚀 Deploy to Vercel (placeholder)
        run: echo "✅ App manually approved and ready for deployment to Vercel"
